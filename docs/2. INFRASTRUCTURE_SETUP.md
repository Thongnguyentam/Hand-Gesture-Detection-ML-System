# 2. Infrastructure Setup Guide

This guide provides the detailed, one-time commands required to provision the project's cloud infrastructure on Google Cloud Platform (GCP).

---

## A Closer Look at Our Cloud Foundation

At the heart of this project lies a carefully crafted infrastructure, defined declaratively using Terraform in the `iac/` directory. This approach ensures that our setup is reproducible, version-controlled, and easy to manage. Our cloud environment consists of two primary actors working in concert: a powerful Google Kubernetes Engine (GKE) cluster to run our application and a dedicated Jenkins VM to orchestrate our continuous integration and deployment (CI/CD) pipeline.

### The Workhorse: Google Kubernetes Engine (GKE) Cluster

The GKE cluster, named `asl-cluster`, is the stage where our hand gesture detection API performs. It's a GKE Standard cluster, which provides us with granular control over its configuration, allowing us to fine-tune the environment to meet the specific demands of our workloads.

-   **Cluster Configuration**: The cluster is provisioned in the `us-central1` region with a single node to start, built on an `e2-standard-2` machine type. This offers a balanced blend of computing power and cost-efficiency, perfect for our development and deployment needs.
-   **Scalability**: While we start with one node, the power of GKE lies in its ability to scale effortlessly as our application's traffic and complexity grow.

### The Conductor: The Jenkins CI/CD Server

Automation is key to modern software development. Our CI/CD pipeline is driven by a `jenkins-asl` Compute Engine instance, a virtual machine dedicated to building, testing, and deploying our application.

-   **Self-Configuring VM**: This isn't just a blank server. Thanks to the `jenkins_startup.sh` script, the VM provisions itself upon creation. It installs everything needed to get the job done:
    -   **Docker**: To create and manage containerized environments for our builds.
    -   **Jenkins**: The core of our automation server.
    -   **Kubectl & Helm**: The essential tools for communicating with our GKE cluster and deploying our application using Helm charts.
    -   **GCP SDK**: To authenticate and interact with other Google Cloud services securely.
-   **Secure Accessibility**: A specific firewall rule, `jenkins-asl-firewall`, is created alongside the instance. It selectively opens ports like `8080` for the Jenkins web UI and `22` for SSH access, ensuring the server is both accessible for us and secure from unwanted traffic.

Together, these resources—orchestrated by a few simple Terraform commands—form a robust, automated, and scalable foundation for the Hand Gesture Detection API.

---

## 1. Provision GCP Resources with Terraform

These steps use Terraform to declaratively create the GKE cluster and the Jenkins VM as defined in the `iac/` directory. This approach ensures your infrastructure is reproducible and version-controlled.

1.  **Navigate to the Infrastructure Directory:**
    ```shell
    cd iac/
    ```

2.  **Initialize Terraform:**
    This downloads the required GCP provider plugins and prepares the workspace.
    ```shell
    terraform init
    ```

3.  **Review and Apply the Plan:**
    `terraform plan` shows a "dry run" of the resources to be created. `terraform apply` executes the plan.
    ```shell
    terraform plan
    terraform apply
    ```
    This process can take several minutes as it waits for GCP to create the GKE cluster and compute instance.

---

## 2. Verify Infrastructure Health

After Terraform completes, it's crucial to verify that all resources were created successfully and are accessible.

1.  **Check the GKE Cluster:**
    Verify that the GKE cluster is running and in a `RUNNING` state.
    ```shell
    gcloud container clusters list
    ```

2.  **Check the Jenkins VM Instance:**
    Verify that the `jenkins-asl` compute instance is also `RUNNING`.
    ```shell
    gcloud compute instances list
    ```

3.  **Check Firewall Rules:**
    Ensure the firewall rule (`jenkins-firewall`) was created to allow traffic on the necessary ports (e.g., `8080` for the UI, `22` for SSH).
    ```shell
    gcloud compute firewall-rules list
    ```

4.  **Connect `kubectl` to the New Cluster:**
    This command updates your local `kubeconfig` file with the credentials and endpoint for your new GKE cluster, allowing you to interact with it.
    ```shell
    gcloud container clusters get-credentials asl-cluster --region us-central1
    ```

5.  **Verify Cluster Connectivity:**
    A successful response to this command confirms that you have authenticated to the cluster and have basic permissions.
    ```shell
    kubectl get nodes
    ```
    You should see the nodes that make up your GKE cluster.

6.  Check Kubernetes context and change the context
```shell
kubectl config get-contexts
kubectx
```

---

## 3. Post-Provisioning Steps

-   **Create the Namespace:** Your Helm chart deploys to the `model-serving` namespace. You can create it ahead of time.
    ```shell
    kubectl create ns model-serving
    ```
-   **Restart the Instance (If Needed):** If the startup script for the Jenkins VM fails for any reason, you can trigger it to run again by resetting the instance.
    ```shell
    gcloud compute instances reset jenkins-asl --zone us-central1-a
    ```
-   **Watch Startup Logs:** To debug the Jenkins VM startup script, you can tail the serial port output.
    ```shell
    gcloud compute instances get-serial-port-output jenkins-asl --zone us-central1-a --port 1
    ```