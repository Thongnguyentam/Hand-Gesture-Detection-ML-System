# 2. Infrastructure Setup Guide

This guide provides the detailed, one-time commands required to provision the project's cloud infrastructure on Google Cloud Platform (GCP).

---

## 1. Provision GCP Resources with Terraform

These steps use Terraform to declaratively create the GKE cluster and the Jenkins VM as defined in the `iac/` directory. This approach ensures your infrastructure is reproducible and version-controlled.

1.  **Navigate to the Infrastructure Directory:**
    ```shell
    cd iac/
    ```

2.  **Initialize Terraform:**
    This downloads the required GCP provider plugins and prepares the workspace.
    ```shell
    terraform init
    ```

3.  **Review and Apply the Plan:**
    `terraform plan` shows a "dry run" of the resources to be created. `terraform apply` executes the plan.
    ```shell
    terraform plan
    terraform apply
    ```
    This process can take several minutes as it waits for GCP to create the GKE cluster and compute instance.

---

## 2. Verify Infrastructure Health

After Terraform completes, it's crucial to verify that all resources were created successfully and are accessible.

1.  **Check the GKE Cluster:**
    Verify that the GKE cluster is running and in a `RUNNING` state.
    ```shell
    gcloud container clusters list
    ```

2.  **Check the Jenkins VM Instance:**
    Verify that the `jenkins-asl` compute instance is also `RUNNING`.
    ```shell
    gcloud compute instances list
    ```

3.  **Check Firewall Rules:**
    Ensure the firewall rule (`jenkins-firewall`) was created to allow traffic on the necessary ports (e.g., `8080` for the UI, `22` for SSH).
    ```shell
    gcloud compute firewall-rules list
    ```

4.  **Connect `kubectl` to the New Cluster:**
    This command updates your local `kubeconfig` file with the credentials and endpoint for your new GKE cluster, allowing you to interact with it.
    ```shell
    gcloud container clusters get-credentials asl-cluster --region us-central1
    ```

5.  **Verify Cluster Connectivity:**
    A successful response to this command confirms that you have authenticated to the cluster and have basic permissions.
    ```shell
    kubectl get nodes
    ```
    You should see the nodes that make up your GKE cluster.

6.  Check Kubernetes context and change the context
```shell
kubectl config get-contexts
kubectx
```

---

## 3. Post-Provisioning Steps

-   **Create the Namespace:** Your Helm chart deploys to the `model-serving` namespace. You can create it ahead of time.
    ```shell
    kubectl create ns model-serving
    ```
-   **Restart the Instance (If Needed):** If the startup script for the Jenkins VM fails for any reason, you can trigger it to run again by resetting the instance.
    ```shell
    gcloud compute instances reset jenkins-asl --zone us-central1-a
    ```
-   **Watch Startup Logs:** To debug the Jenkins VM startup script, you can tail the serial port output.
    ```shell
    gcloud compute instances get-serial-port-output jenkins-asl --zone us-central1-a --port 1
    ```

```shell
kubectl get service --namespace ingress-nginx ingress-nginx-controller --output wide
```

You can see something like this:
```console
NAME                       TYPE           CLUSTER-IP    EXTERNAL-IP    PORT(S)                      AGE     SELECTOR
ingress-nginx-controller   LoadBalancer   10.3.251.92   34.63.222.25   80:31840/TCP,443:30840/TCP   7h36m   app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/name=ingress-nginx
```

```console
k logs hand-gesture-deployment-5c75bbc6db-slxkw -n model-serving
```